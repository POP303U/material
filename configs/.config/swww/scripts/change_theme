#!/bin/bash

set -x

case "$1" in
    "Rose-Pine-Dawn")
        export CURRENT_BG="material_pastel_1.jpg"
        export MODE="light"
        ;;
    "Rose-Pine-Moon")
        export CURRENT_BG="moon-leafy.png"
        export MODE="dark"
        ;;
    "Rose-Pine")
        export CURRENT_BG="pine-anime_city.png"
        export MODE="dark"
        ;;
    "Gruvbox-Dark")
        export CURRENT_BG="gruvbox-garden.png"
        export MODE="dark"
        ;;
    "Gruvbox-Light")
        export CURRENT_BG="gruvbox-light-mountains.png"
        export MODE="light"
        ;;
    "Catppuccin-Mocha")
        export CURRENT_BG="rain_world1.png"
        export MODE="dark"
        ;;
    "Catppuccin-Latte")
        export CURRENT_BG="latte-cloud.png"
        export MODE="light"
        ;;
    "Titanium-Mono")
        export CURRENT_BG="titanium-mono-gojo.png"
        export MODE="dark"
        ;;
    "Solarized-Dark")
        export CURRENT_BG="solarized-dark-construction.png"
        export MODE="dark"
        ;;
    "Solarized-Light")
        export CURRENT_BG="solarized-light-post-modern.png"
        export MODE="light"
        ;;
    "Nord")
        export CURRENT_BG="misty-mountain.jpg"
        export MODE="dark"
        ;;
    *)
        echo "Unsupported operation: $1"
        exit 1
        ;;
esac

sed -i 's|^rice-current.*|rice-current = '${1}'|' ~/.config/material/config # set theme in config before using it as a variable in this script
CURRENT_RICE=$(awk '/rice-current/ {print $NF}' "$HOME/.config/material/config")
CURRENT_ICONS="$(grep -m 2 "=" "${CONF_DIR}/gtk-3.0/settings.ini" | tail -n 1 | awk -F '=' '{print $2}')"
CURRENT_BG=${2:-$CURRENT_BG} # make manual wallpapers possible

# Swww
TRANSITION_TYPE=$(awk '/rice-transition/ {print $NF}' "$HOME/.config/material/config")
sed -i 's|wallpaper-current.*|wallpaper-current = '${CURRENT_BG}'|' ~/.config/material/config

# you need dynamic `rose-pine-sddm` for this to work, check the installer for this option
cp -vrf ~/.config/swww/walls/${CURRENT_RICE}/${CURRENT_BG} /usr/share/sddm/themes/rose-pine-sddm/Backgrounds/current
swww img "$HOME/.config/swww/walls/${CURRENT_RICE}/$CURRENT_BG" \
    --transition-bezier .6,.94,.86,.23     \
    --transition-type "${TRANSITION_TYPE}" \
    --transition-duration 0.7              \
    --transition-fps 144                   \
    --invert-y                             \
    --transition-pos "2502, 1410"


# Wofi
sed -i -e '/@define-color base/s: .*;: base '"$(awk '/@define-color base/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color surface/s: .*;: surface '"$(awk '/@define-color surface/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color overlay/s: .*;: overlay '"$(awk '/@define-color overlay/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color muted/s: .*;: muted '"$(awk '/@define-color muted/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color subtle/s: .*;: subtle '"$(awk '/@define-color subtle/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color text/s: .*;: text '"$(awk '/@define-color text/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color love/s: .*;: love '"$(awk '/@define-color love/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color gold/s: .*;: gold '"$(awk '/@define-color gold/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color rose/s: .*;: rose '"$(awk '/@define-color rose/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color pine/s: .*;: pine '"$(awk '/@define-color pine/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color foam/s: .*;: foam '"$(awk '/@define-color foam/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':' \
    -e '/@define-color iris/s: .*;: iris '"$(awk '/@define-color iris/ {print $NF}' ~/.config/wofi/themes/${CURRENT_RICE}.css)"':'  ~/.config/wofi/style.css

# Tmux
sed -i 's|^set -g status-bg.*|set -g status-bg '$([[ "$MODE" == "light" ]] && echo "white" || echo "black" )'|' $HOME/.tmux.conf

# Neovim
_NVIM_THEME="$CURRENT_RICE"
[[ "$CURRENT_RICE" == "Titanium-Mono" ]]                                            && _NVIM_THEME="monochrome"
[[ "$CURRENT_RICE" == "Gruvbox-Dark"  || "$CURRENT_RICE" == "Gruvbox-Light" ]]      && _NVIM_THEME="gruvbox"
[[ "$CURRENT_RICE" == "Solarized-Dark" || "$CURRENT_RICE" == "Solarized-Light" ]]   && _NVIM_THEME="solarized"  
[[ "$CURRENT_RICE" == "Nord" ]]                                                     && _NVIM_THEME="nord"
NVIM_THEME=$(echo $_NVIM_THEME | tr '[:upper:]' '[:lower:]')

sed -i 's|^vim.cmd.*|vim.cmd.colorscheme("'${NVIM_THEME}'")|' $HOME/.config/nvim/lua/core/plugins/colorscheme.lua
sed -i 's|^vim.opt.*|vim.opt.background = "'${MODE}'"|' $HOME/.config/nvim/lua/core/plugins/colorscheme.lua
# works only with my neovim dotfiles: https://github.com/POP303U/kickstart-nvim and these plugins:
#    'rose-pine/neovim',
#    'shaunsingh/solarized.nvim',
#    'catppuccin/nvim',
#    'fxn/vim-monochrome',
#    'shaunsingh/nord.nvim',
#    'ellisonleao/gruvbox.nvim',

# Dunst
sed -i 's|background.*|'"$(sed -n '1p' $HOME/.config/dunst/themes/${CURRENT_RICE})"'|' $HOME/.config/dunst/dunstrc
sed -i 's|foreground.*|'"$(sed -n '2p' $HOME/.config/dunst/themes/${CURRENT_RICE})"'|' $HOME/.config/dunst/dunstrc
sed -i 's|frame_color.*|'"$(sed -n '3p' $HOME/.config/dunst/themes/${CURRENT_RICE})"'|' $HOME/.config/dunst/dunstrc
kill -SIGTERM $(pidof dunst); dunst & disown # reload

# Cava
for ((I=1; I<8; I++)); do
    sed -i 's|^gradient_color_'$I'.*|'"$(sed -n ''$I'p' $HOME/.config/cava/themes/${CURRENT_RICE})"'|' ~/.config/cava/config
done
kill -SIGUSR2 $(pidof cava)

# Kvantum
kvantummanager --set ${CURRENT_RICE}

# qt5ct 
sed -i "s|^color_scheme_path=.*|color_scheme_path=$HOME/.config/qt5ct/colors/${CURRENT_RICE}.conf|" $HOME/.config/qt5ct/qt5ct.conf

# qt6ct
sed -i "s|^color_scheme_path=.*|color_scheme_path=$HOME/.config/qt6ct/colors/${CURRENT_RICE}.conf|" $HOME/.config/qt6ct/qt6ct.conf

# gtk3
sed -i 's|^gtk-theme-name.*|gtk-theme-name='${CURRENT_RICE}'|' ~/.config/gtk-3.0/settings.ini
~/.config/hypr/scripts/import-gsettings

# flatpak gtk
flatpak --user override --env=GTK_THEME="${CURRENT_RICE}" # flatpak gtk is not intended to work, and very hacky not all apps will work with this
flatpak --user override --env=ICON_THEME="${CURRENT_ICONS}"

# Kitty
ln -sf ~/.config/kitty/themes/${CURRENT_RICE}.conf ~/.config/kitty/themes/theme.conf 
kill -SIGUSR1 $(pidof kitty) # reload

# Waybar
ln -sf ~/.config/waybar/themes/${CURRENT_RICE}.css ~/.config/waybar/themes/theme.css
~/.config/hypr/scripts/manage-waybar &

# Wlogout
ln -sf ~/.config/wlogout/themes/${CURRENT_RICE}.css ~/.config/wlogout/themes/theme.css

# Fuzzel
ln -sf $HOME/.config/fuzzel/themes/${CURRENT_RICE}.ini $HOME/.config/fuzzel/fuzzel.ini

# Rofi
ln -sf $HOME/.config/rofi/themes/${CURRENT_RICE}.rasi $HOME/.config/rofi/themes/theme.rasi

# Dolphin (just reloading)
ACTIVE_WORKSPACE=$(hyprctl -j activeworkspace | jq '.id')
if [ "$(hyprctl -j clients | jq --arg wid "$ACTIVE_WORKSPACE" '.[] | select(.workspace.id == ($wid | tonumber)) | select(.class == "org.kde.dolphin") | .mapped')" == "true" ] ; then
    pkill -x dolphin
    dolphin &
fi

# Hyprland
ln -sf ~/.config/hypr/themes/${CURRENT_RICE}.conf ~/.config/hypr/themes/theme.conf 
hyprctl reload
